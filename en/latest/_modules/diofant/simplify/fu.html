

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>diofant.simplify.fu &mdash; Diofant 0.10.0b2.dev55+g97f1e5f documentation</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/graphviz.css" type="text/css" />
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 

  
  <script src="../../../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../../../index.html" class="icon icon-home"> Diofant
          

          
          </a>

          
            
            
              <div class="version">
                0.10.0b2.dev55+g97f1e5f
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial/index.html">Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules/index.html">Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../internals/index.html">Internals</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../guide.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../aboutus.html">About</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release/index.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../bibliography.html">Bibliography</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">Diofant</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../../index.html">Module code</a> &raquo;</li>
        
      <li>diofant.simplify.fu</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for diofant.simplify.fu</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Implementation of the trigsimp algorithm by Fu et al.</span>

<span class="sd">The idea behind the ``fu`` algorithm is to use a sequence of rules, applied</span>
<span class="sd">in what is heuristically known to be a smart order, to select a simpler</span>
<span class="sd">expression that is equivalent to the input.</span>

<span class="sd">There are transform rules in which a single rule is applied to the</span>
<span class="sd">expression tree. The following are just mnemonic in nature; see the</span>
<span class="sd">docstrings for examples.</span>

<span class="sd">    TR0 - simplify expression</span>
<span class="sd">    TR1 - sec-csc to cos-sin</span>
<span class="sd">    TR2 - tan-cot to sin-cos ratio</span>
<span class="sd">    TR2i - sin-cos ratio to tan</span>
<span class="sd">    TR3 - angle canonicalization</span>
<span class="sd">    TR4 - functions at special angles</span>
<span class="sd">    TR5 - powers of sin to powers of cos</span>
<span class="sd">    TR6 - powers of cos to powers of sin</span>
<span class="sd">    TR7 - reduce cos power (increase angle)</span>
<span class="sd">    TR8 - expand products of sin-cos to sums</span>
<span class="sd">    TR9 - contract sums of sin-cos to products</span>
<span class="sd">    TR10 - separate sin-cos arguments</span>
<span class="sd">    TR10i - collect sin-cos arguments</span>
<span class="sd">    TR11 - reduce double angles</span>
<span class="sd">    TR12 - separate tan arguments</span>
<span class="sd">    TR12i - collect tan arguments</span>
<span class="sd">    TR13 - expand product of tan-cot</span>
<span class="sd">    TRmorrie - prod(cos(x*2**i), (i, 0, k - 1)) -&gt; sin(2**k*x)/(2**k*sin(x))</span>
<span class="sd">    TR14 - factored powers of sin or cos to cos or sin power</span>
<span class="sd">    TR15 - negative powers of sin to cot power</span>
<span class="sd">    TR16 - negative powers of cos to tan power</span>
<span class="sd">    TR22 - tan-cot powers to negative powers of sec-csc functions</span>
<span class="sd">    TR111 - negative sin-cos-tan powers to csc-sec-cot</span>

<span class="sd">There are 4 combination transforms (CTR1 - CTR4) in which a sequence of</span>
<span class="sd">transformations are applied and the simplest expression is selected from</span>
<span class="sd">a few options.</span>

<span class="sd">Finally, there are the 2 rule lists (RL1 and RL2), which apply a</span>
<span class="sd">sequence of transformations and combined transformations, and the ``fu``</span>
<span class="sd">algorithm itself, which applies rules and rule lists and selects the</span>
<span class="sd">best expressions. There is also a function ``L`` which counts the number</span>
<span class="sd">of trigonometric functions that appear in the expression.</span>

<span class="sd">Other than TR0, re-writing of expressions is not done by the transformations.</span>
<span class="sd">e.g. TR10i finds pairs of terms in a sum that are in the form like</span>
<span class="sd">``cos(x)*cos(y) + sin(x)*sin(y)``. Such expression are targeted in a bottom-up</span>
<span class="sd">traversal of the expression, but no manipulation to make them appear is</span>
<span class="sd">attempted. For example,</span>

<span class="sd">    Set-up for examples below:</span>

<span class="sd">    &gt;&gt;&gt; from time import time</span>

<span class="sd">&gt;&gt;&gt; eq = cos(x + y)/cos(x)</span>
<span class="sd">&gt;&gt;&gt; TR10i(eq.expand(trig=True))</span>
<span class="sd">-sin(x)*sin(y)/cos(x) + cos(y)</span>

<span class="sd">If the expression is put in &quot;normal&quot; form (with a common denominator) then</span>
<span class="sd">the transformation is successful:</span>

<span class="sd">&gt;&gt;&gt; TR10i(_.normal())</span>
<span class="sd">cos(x + y)/cos(x)</span>

<span class="sd">TR11&#39;s behavior is similar. It rewrites double angles as smaller angles but</span>
<span class="sd">doesn&#39;t do any simplification of the result.</span>

<span class="sd">&gt;&gt;&gt; TR11(sin(2)**a*cos(1)**(-a), 1)</span>
<span class="sd">(2*sin(1)*cos(1))**a*cos(1)**(-a)</span>
<span class="sd">&gt;&gt;&gt; powsimp(_)</span>
<span class="sd">(2*sin(1))**a</span>

<span class="sd">The temptation is to try make these TR rules &quot;smarter&quot; but that should really</span>
<span class="sd">be done at a higher level; the TR rules should try maintain the &quot;do one thing</span>
<span class="sd">well&quot; principle.  There is one exception, however. In TR10i and TR9 terms are</span>
<span class="sd">recognized even when they are each multiplied by a common factor:</span>

<span class="sd">&gt;&gt;&gt; fu(a*cos(x)*cos(y) + a*sin(x)*sin(y))</span>
<span class="sd">a*cos(x - y)</span>

<span class="sd">Factoring with ``factor_terms`` is used but it it &quot;JIT&quot;-like, being delayed</span>
<span class="sd">until it is deemed necessary. Furthermore, if the factoring does not</span>
<span class="sd">help with the simplification, it is not retained, so</span>
<span class="sd">``a*cos(x)*cos(y) + a*sin(x)*sin(z)`` does not become the factored</span>
<span class="sd">(but unsimplified in the trigonometric sense) expression:</span>

<span class="sd">&gt;&gt;&gt; fu(a*cos(x)*cos(y) + a*sin(x)*sin(z))</span>
<span class="sd">a*sin(x)*sin(z) + a*cos(x)*cos(y)</span>

<span class="sd">In some cases factoring might be a good idea, but the user is left</span>
<span class="sd">to make that decision. For example:</span>

<span class="sd">&gt;&gt;&gt; expr = ((15*sin(2*x) + 19*sin(x + y) + 17*sin(x + z) + 19*cos(x - z) +</span>
<span class="sd">...          25)*(20*sin(2*x) + 15*sin(x + y) + sin(y + z) + 14*cos(x - z) +</span>
<span class="sd">...               14*cos(y - z))*(9*sin(2*y) + 12*sin(y + z) +</span>
<span class="sd">...                               10*cos(x - y) + 2*cos(y - z) +</span>
<span class="sd">...                               18)).expand(trig=True).expand()</span>

<span class="sd">In the expanded state, there are nearly 1000 trig functions:</span>

<span class="sd">&gt;&gt;&gt; L(expr)</span>
<span class="sd">932</span>

<span class="sd">If the expression where factored first, this would take time but the</span>
<span class="sd">resulting expression would be transformed very quickly:</span>

<span class="sd">&gt;&gt;&gt; def clock(f, n=2):</span>
<span class="sd">...    t = time(); f(); return round(time() - t, n)</span>
<span class="sd">...</span>
<span class="sd">&gt;&gt;&gt; clock(lambda: factor(expr))  # doctest: +SKIP</span>
<span class="sd">0.86</span>
<span class="sd">&gt;&gt;&gt; clock(lambda: TR10i(expr), 3)  # doctest: +SKIP</span>
<span class="sd">0.016</span>

<span class="sd">If the unexpanded expression is used, the transformation takes longer but</span>
<span class="sd">not as long as it took to factor it and then transform it:</span>

<span class="sd">&gt;&gt;&gt; clock(lambda: TR10i(expr), 2)  # doctest: +SKIP</span>
<span class="sd">0.28</span>

<span class="sd">So neither expansion nor factoring is used in ``TR10i``: if the</span>
<span class="sd">expression is already factored (or partially factored) then expansion</span>
<span class="sd">with ``trig=True`` would destroy what is already known and take</span>
<span class="sd">longer; if the expression is expanded, factoring may take longer than</span>
<span class="sd">simply applying the transformation itself.</span>

<span class="sd">Although the algorithms should be canonical, always giving the same</span>
<span class="sd">result, they may not yield the best result. This, in general, is</span>
<span class="sd">the nature of simplification where searching all possible transformation</span>
<span class="sd">paths is very expensive. Here is a simple example. There are 6 terms</span>
<span class="sd">in the following sum:</span>

<span class="sd">&gt;&gt;&gt; expr = (sin(x)**2*cos(y)*cos(z) + sin(x)*sin(y)*cos(x)*cos(z) +</span>
<span class="sd">... sin(x)*sin(z)*cos(x)*cos(y) + sin(y)*sin(z)*cos(x)**2 + sin(y)*sin(z) +</span>
<span class="sd">... cos(y)*cos(z))</span>
<span class="sd">&gt;&gt;&gt; args = expr.args</span>

<span class="sd">Serendipitously, fu gives the best result:</span>

<span class="sd">&gt;&gt;&gt; fu(expr)</span>
<span class="sd">3*cos(y - z)/2 - cos(2*x + y + z)/2</span>

<span class="sd">But if different terms were combined, a less-optimal result might be</span>
<span class="sd">obtained, requiring some additional work to get better simplification,</span>
<span class="sd">but still less than optimal. The following shows an alternative form</span>
<span class="sd">of ``expr`` that resists optimal simplification once a given step</span>
<span class="sd">is taken since it leads to a dead end:</span>

<span class="sd">&gt;&gt;&gt; TR9(-cos(x)**2*cos(y + z) + 3*cos(y - z)/2 +</span>
<span class="sd">...     cos(y + z)/2 + cos(-2*x + y + z)/4 - cos(2*x + y + z)/4)</span>
<span class="sd">sin(2*x)*sin(y + z)/2 - cos(x)**2*cos(y + z) + 3*cos(y - z)/2 + cos(y + z)/2</span>

<span class="sd">Here is a smaller expression that exhibits the same behavior:</span>

<span class="sd">&gt;&gt;&gt; a = sin(x)*sin(z)*cos(x)*cos(y) + sin(x)*sin(y)*cos(x)*cos(z)</span>
<span class="sd">&gt;&gt;&gt; TR10i(a)</span>
<span class="sd">sin(x)*sin(y + z)*cos(x)</span>
<span class="sd">&gt;&gt;&gt; newa = _</span>
<span class="sd">&gt;&gt;&gt; TR10i(expr - a)  # this combines two more of the remaining terms</span>
<span class="sd">sin(x)**2*cos(y)*cos(z) + sin(y)*sin(z)*cos(x)**2 + cos(y - z)</span>
<span class="sd">&gt;&gt;&gt; TR10i(_ + newa) == _ + newa  # but now there is no more simplification</span>
<span class="sd">True</span>

<span class="sd">Without getting lucky or trying all possible pairings of arguments, the</span>
<span class="sd">final result may be less than optimal and impossible to find without</span>
<span class="sd">better heuristics or brute force trial of all possibilities.</span>

<span class="sd">Notes</span>
<span class="sd">=====</span>

<span class="sd">This work was started by Dimitar Vlahovski at the Technological School</span>
<span class="sd">&quot;Electronic systems&quot; (30.11.2011).</span>

<span class="sd">References</span>
<span class="sd">==========</span>

<span class="sd">Fu, Hongguang, Xiuqin Zhong, and Zhenbing Zeng. &quot;Automated and readable</span>
<span class="sd">simplification of trigonometric expressions.&quot; Mathematical and computer</span>
<span class="sd">modelling 44.11 (2006): 1169-1177.</span>
<span class="sd">http://rfdz.ph-noe.ac.at/fileadmin/Mathematik_Uploads/ACDCA/DESTIME2006/DES_contribs/Fu/simplification.pdf</span>

<span class="sd">http://www.sosmath.com/trig/Trig5/trig5/pdf/pdf.html gives a formula sheet.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">collections</span> <span class="k">import</span> <span class="n">defaultdict</span>

<span class="kn">from</span> <span class="nn">strategies.core</span> <span class="k">import</span> <span class="n">debug</span><span class="p">,</span> <span class="n">identity</span>
<span class="kn">from</span> <span class="nn">strategies.tree</span> <span class="k">import</span> <span class="n">greedy</span>

<span class="kn">from</span> <span class="nn">..</span> <span class="k">import</span> <span class="n">DIOFANT_DEBUG</span>
<span class="kn">from</span> <span class="nn">..core</span> <span class="k">import</span> <span class="p">(</span><span class="n">Add</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">,</span> <span class="n">Expr</span><span class="p">,</span> <span class="n">I</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">Mul</span><span class="p">,</span> <span class="n">Pow</span><span class="p">,</span> <span class="n">S</span><span class="p">,</span> <span class="n">expand_mul</span><span class="p">,</span>
                    <span class="n">factor_terms</span><span class="p">,</span> <span class="n">gcd_terms</span><span class="p">,</span> <span class="n">pi</span><span class="p">,</span> <span class="n">sympify</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..core.compatibility</span> <span class="k">import</span> <span class="n">ordered</span>
<span class="kn">from</span> <span class="nn">..core.exprtools</span> <span class="k">import</span> <span class="n">Factors</span>
<span class="kn">from</span> <span class="nn">..functions</span> <span class="k">import</span> <span class="p">(</span><span class="n">binomial</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">cosh</span><span class="p">,</span> <span class="n">cot</span><span class="p">,</span> <span class="n">coth</span><span class="p">,</span> <span class="n">csc</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">sinh</span><span class="p">,</span>
                         <span class="n">sqrt</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">tanh</span><span class="p">)</span>
<span class="kn">from</span> <span class="nn">..functions.elementary.hyperbolic</span> <span class="k">import</span> <span class="n">HyperbolicFunction</span>
<span class="kn">from</span> <span class="nn">..functions.elementary.trigonometric</span> <span class="k">import</span> <span class="n">TrigonometricFunction</span>
<span class="kn">from</span> <span class="nn">..ntheory</span> <span class="k">import</span> <span class="n">perfect_power</span>
<span class="kn">from</span> <span class="nn">..polys.polytools</span> <span class="k">import</span> <span class="n">factor</span>
<span class="kn">from</span> <span class="nn">.simplify</span> <span class="k">import</span> <span class="n">bottom_up</span>


<span class="c1"># ================== Fu-like tools ===========================</span>


<span class="k">def</span> <span class="nf">TR0</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simplification of rational polynomials, trying to simplify</span>
<span class="sd">    the expression, e.g. combine things like 3*x + 2*x, etc....</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># although it would be nice to use cancel, it doesn&#39;t work</span>
    <span class="c1"># with noncommutatives</span>
    <span class="k">return</span> <span class="n">rv</span><span class="o">.</span><span class="n">normal</span><span class="p">()</span><span class="o">.</span><span class="n">factor</span><span class="p">()</span><span class="o">.</span><span class="n">expand</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">TR1</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace sec, csc with 1/cos, 1/sin</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR1(2*csc(x) + sec(x))</span>
<span class="sd">    1/cos(x) + 2/sin(x)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">sec</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">csc</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR2</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace tan and cot with sin/cos and cos/sin</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR2(tan(x))</span>
<span class="sd">    sin(x)/cos(x)</span>
<span class="sd">    &gt;&gt;&gt; TR2(cot(x))</span>
<span class="sd">    cos(x)/sin(x)</span>
<span class="sd">    &gt;&gt;&gt; TR2(tan(tan(x) - sin(x)/cos(x)))</span>
<span class="sd">    0</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">tan</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">cot</span><span class="p">):</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">return</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR2i</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">half</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converts ratios involving sin and cos as follows::</span>
<span class="sd">        sin(x)/cos(x) -&gt; tan(x)</span>
<span class="sd">        sin(x)/(cos(x) + 1) -&gt; tan(x/2) if half=True</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR2i(sin(x)/cos(x))</span>
<span class="sd">    tan(x)</span>

<span class="sd">    Powers of the numerator and denominator are also recognized</span>

<span class="sd">    &gt;&gt;&gt; TR2i(sin(x)**2/(cos(x) + 1)**2, half=True)</span>
<span class="sd">    tan(x/2)**2</span>

<span class="sd">    The transformation does not take place unless assumptions allow</span>
<span class="sd">    (i.e. the base must be positive or the exponent must be an integer</span>
<span class="sd">    for both numerator and denominator)</span>

<span class="sd">    &gt;&gt;&gt; TR2i(sin(x)**a/(cos(x) + 1)**a)</span>
<span class="sd">    (cos(x) + 1)**(-a)*sin(x)**a</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">as_numer_denom</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_Atom</span> <span class="ow">or</span> <span class="n">d</span><span class="o">.</span><span class="n">is_Atom</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">e</span><span class="p">):</span>
            <span class="c1"># initial filtering of factors</span>
            <span class="k">return</span> <span class="p">(</span>
                <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">or</span> <span class="n">k</span><span class="o">.</span><span class="n">is_positive</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span>
                    <span class="n">k</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">half</span> <span class="ow">and</span>
                                             <span class="n">k</span><span class="o">.</span><span class="n">is_Add</span> <span class="ow">and</span>
                                             <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">2</span> <span class="ow">and</span>
                                             <span class="nb">any</span><span class="p">(</span><span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ai</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span> <span class="ow">or</span> <span class="n">ai</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">ai</span><span class="o">.</span><span class="n">base</span> <span class="ow">is</span> <span class="n">cos</span>
                                                     <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="n">Mul</span><span class="o">.</span><span class="n">make_args</span><span class="p">(</span><span class="n">a</span><span class="p">))</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">))))</span>

        <span class="n">n</span> <span class="o">=</span> <span class="n">n</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span>
        <span class="n">ndone</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">d</span> <span class="o">=</span> <span class="n">d</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span>
        <span class="n">ddone</span> <span class="o">=</span> <span class="p">[(</span><span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">k</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">d</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">ok</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">])]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="c1"># factoring if necessary</span>

        <span class="k">def</span> <span class="nf">factorize</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ddone</span><span class="p">):</span>
            <span class="n">newk</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">k</span><span class="o">.</span><span class="n">is_Add</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">knew</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">k</span><span class="p">)</span> <span class="k">if</span> <span class="n">half</span> <span class="k">else</span> <span class="n">factor_terms</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">knew</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
                        <span class="n">newk</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">knew</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">newk</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">knew</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">newk</span><span class="p">):</span>
                    <span class="k">del</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="n">newk</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">knew</span>
                <span class="n">newk</span> <span class="o">=</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">newk</span><span class="p">)</span><span class="o">.</span><span class="n">as_powers_dict</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">newk</span><span class="p">:</span>
                    <span class="n">v</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">+</span> <span class="n">newk</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ok</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">):</span>
                        <span class="n">d</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">ddone</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">))</span>
                <span class="k">del</span> <span class="n">newk</span>
        <span class="n">factorize</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">ndone</span><span class="p">)</span>
        <span class="n">factorize</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">ddone</span><span class="p">)</span>

        <span class="c1"># joining</span>
        <span class="n">t</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">n</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">elif</span> <span class="n">half</span><span class="p">:</span>
                    <span class="n">a1</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">a</span>
                    <span class="k">if</span> <span class="n">a1</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                        <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">tan</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">))</span><span class="o">**</span><span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                        <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">a1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**-</span><span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">half</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">is_Add</span> <span class="ow">and</span> <span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span> <span class="ow">and</span>
                  <span class="nb">isinstance</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">cos</span><span class="p">)):</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">k</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">d</span> <span class="ow">and</span> <span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">==</span> <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="ow">and</span> <span class="p">(</span><span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">or</span>
                                                <span class="n">a</span><span class="o">.</span><span class="n">is_positive</span><span class="p">):</span>
                    <span class="n">t</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**-</span><span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>
                    <span class="n">n</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">d</span><span class="p">[</span><span class="n">a</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">t</span> <span class="o">+</span> <span class="p">[</span><span class="n">b</span><span class="o">**</span><span class="n">e</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">n</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span><span class="p">]))</span> <span class="o">/</span>\
                <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">b</span><span class="o">**</span><span class="n">e</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">d</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">e</span><span class="p">])</span>
            <span class="n">rv</span> <span class="o">*=</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">b</span><span class="o">**</span><span class="n">e</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ndone</span><span class="p">])</span><span class="o">/</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">b</span><span class="o">**</span><span class="n">e</span> <span class="k">for</span> <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">ddone</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR3</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Induced formula: example sin(-a) = -sin(a)</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR3(cos(y - x*(y - x)))</span>
<span class="sd">    cos(x*(x - y) + y)</span>
<span class="sd">    &gt;&gt;&gt; cos(pi/2 + x)</span>
<span class="sd">    -sin(x)</span>
<span class="sd">    &gt;&gt;&gt; cos(30*pi/2 + x)</span>
<span class="sd">    -cos(x)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.simplify</span> <span class="k">import</span> <span class="n">signsimp</span>

    <span class="c1"># Negative argument (already automatic for funcs like sin(-x) -&gt; -sin(x)</span>
    <span class="c1"># but more complicated expressions can use it, too). Also, trig angles</span>
    <span class="c1"># between pi/4 and pi/2 are not reduced to an angle between 0 and pi/4.</span>
    <span class="c1"># The following are automatically handled:</span>
    <span class="c1">#   Argument of type: pi/2 +/- angle</span>
    <span class="c1">#   Argument of type: pi +/- angle</span>
    <span class="c1">#   Argument of type : 2k*pi +/- angle</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">TrigonometricFunction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="n">signsimp</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">is_positive</span> <span class="ow">is</span> <span class="p">(</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">is_positive</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">fmap</span> <span class="o">=</span> <span class="p">{</span><span class="n">cos</span><span class="p">:</span> <span class="n">sin</span><span class="p">,</span> <span class="n">sin</span><span class="p">:</span> <span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="p">:</span> <span class="n">cot</span><span class="p">,</span> <span class="n">cot</span><span class="p">:</span> <span class="n">tan</span><span class="p">,</span> <span class="n">sec</span><span class="p">:</span> <span class="n">csc</span><span class="p">,</span> <span class="n">csc</span><span class="p">:</span> <span class="n">sec</span><span class="p">}</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">fmap</span><span class="p">[</span><span class="n">rv</span><span class="o">.</span><span class="n">func</span><span class="p">](</span><span class="n">pi</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR4</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Identify values of special angles.</span>

<span class="sd">        a=  0   pi/6        pi/4        pi/3        pi/2</span>
<span class="sd">    ----------------------------------------------------</span>
<span class="sd">    cos(a)  0   1/2         sqrt(2)/2   sqrt(3)/2   1</span>
<span class="sd">    sin(a)  1   sqrt(3)/2   sqrt(2)/2   1/2         0</span>
<span class="sd">    tan(a)  0   sqt(3)/3    1           sqrt(3)     --</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; for s in (0, pi/6, pi/4, pi/3, pi/2):</span>
<span class="sd">    ...    print(&#39;%s %s %s %s&#39; % (cos(s), sin(s), tan(s), cot(s)))</span>
<span class="sd">    ...</span>
<span class="sd">    1 0 0 zoo</span>
<span class="sd">    sqrt(3)/2 1/2 sqrt(3)/3 sqrt(3)</span>
<span class="sd">    sqrt(2)/2 sqrt(2)/2 1 1</span>
<span class="sd">    1/2 sqrt(3)/2 sqrt(3) sqrt(3)/3</span>
<span class="sd">    0 1 zoo 0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># special values at 0, pi/6, pi/4, pi/3, pi/2 already handled</span>
    <span class="k">return</span> <span class="n">rv</span>


<span class="k">def</span> <span class="nf">_TR56</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">g</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="nb">max</span><span class="p">,</span> <span class="nb">pow</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Helper for TR5 and TR6 to replace f**2 with h(g**2)</span>

<span class="sd">    Options</span>
<span class="sd">    =======</span>

<span class="sd">    max :   controls size of exponent that can appear on f</span>
<span class="sd">            e.g. if max=4 then f**4 will be changed to h(g**2)**2.</span>
<span class="sd">    pow :   controls whether the exponent must be a perfect power of 2</span>
<span class="sd">            e.g. if pow=True (and max &gt;= 6) then f**6 will not be changed</span>
<span class="sd">            but f**8 will be changed to h(g**2)**4</span>

<span class="sd">    &gt;&gt;&gt; h = lambda x: 1 - x</span>
<span class="sd">    &gt;&gt;&gt; _TR56(sin(x)**3, sin, cos, h, 4, False)</span>
<span class="sd">    sin(x)**3</span>
<span class="sd">    &gt;&gt;&gt; _TR56(sin(x)**6, sin, cos, h, 6, False)</span>
<span class="sd">    (-cos(x)**2 + 1)**3</span>
<span class="sd">    &gt;&gt;&gt; _TR56(sin(x)**6, sin, cos, h, 6, True)</span>
<span class="sd">    sin(x)**6</span>
<span class="sd">    &gt;&gt;&gt; _TR56(sin(x)**8, sin, cos, h, 10, True)</span>
<span class="sd">    (-cos(x)**2 + 1)**4</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="c1"># I&#39;m not sure if this transformation should target all even powers</span>
        <span class="c1"># or only those expressible as powers of 2. Also, should it only</span>
        <span class="c1"># make the changes in powers that appear in sums -- making an isolated</span>
        <span class="c1"># change is not going to allow a simplification as far as I can tell.</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">f</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">exp</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">true</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">exp</span> <span class="o">&gt;</span> <span class="nb">max</span><span class="p">)</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">true</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>
        <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">exp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">h</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">exp</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">pow</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">exp</span> <span class="o">%</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">rv</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">exp</span><span class="o">//</span><span class="mi">2</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">perfect_power</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">rv</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">exp</span><span class="o">//</span><span class="mi">2</span>
            <span class="k">return</span> <span class="n">h</span><span class="p">(</span><span class="n">g</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="n">e</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">_f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR5</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replacement of sin**2 with 1 - cos(x)**2.</span>

<span class="sd">    See _TR56 docstring for advanced use of ``max`` and ``pow``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR5(sin(x)**2)</span>
<span class="sd">    -cos(x)**2 + 1</span>
<span class="sd">    &gt;&gt;&gt; TR5(sin(x)**-2)  # unchanged</span>
<span class="sd">    sin(x)**(-2)</span>
<span class="sd">    &gt;&gt;&gt; TR5(sin(x)**4)</span>
<span class="sd">    (-cos(x)**2 + 1)**2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_TR56</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="nb">pow</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR6</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replacement of cos**2 with 1 - sin(x)**2.</span>

<span class="sd">    See _TR56 docstring for advanced use of ``max`` and ``pow``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR6(cos(x)**2)</span>
<span class="sd">    -sin(x)**2 + 1</span>
<span class="sd">    &gt;&gt;&gt; TR6(cos(x)**-2)  #unchanged</span>
<span class="sd">    cos(x)**(-2)</span>
<span class="sd">    &gt;&gt;&gt; TR6(cos(x)**4)</span>
<span class="sd">    (-sin(x)**2 + 1)**2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_TR56</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="nb">pow</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR7</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Lowering the degree of cos(x)**2</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR7(cos(x)**2)</span>
<span class="sd">    cos(2*x)/2 + 1/2</span>
<span class="sd">    &gt;&gt;&gt; TR7(cos(x)**2 + 1)</span>
<span class="sd">    cos(2*x)/2 + 3/2</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">cos</span> <span class="ow">and</span> <span class="n">rv</span><span class="o">.</span><span class="n">exp</span> <span class="o">==</span> <span class="mi">2</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>
        <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">/</span><span class="mi">2</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR8</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Converting products of ``cos`` and/or ``sin`` to a sum or</span>
<span class="sd">    difference of ``cos`` and or ``sin`` terms.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR8(cos(2)*cos(3))</span>
<span class="sd">    cos(5)/2 + cos(1)/2</span>
<span class="sd">    &gt;&gt;&gt; TR8(cos(2)*sin(3))</span>
<span class="sd">    sin(5)/2 + sin(1)/2</span>
<span class="sd">    &gt;&gt;&gt; TR8(sin(2)*sin(3))</span>
<span class="sd">    -cos(5)/2 + cos(1)/2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">is_Mul</span> <span class="ow">or</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span>
                <span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">or</span> <span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_positive</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="p">[</span><span class="n">expand_mul</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">as_numer_denom</span><span class="p">()]</span>
            <span class="n">newn</span> <span class="o">=</span> <span class="n">TR8</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">newd</span> <span class="o">=</span> <span class="n">TR8</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newn</span> <span class="o">!=</span> <span class="n">n</span> <span class="ow">or</span> <span class="n">newd</span> <span class="o">!=</span> <span class="n">d</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">gcd_terms</span><span class="p">(</span><span class="n">newn</span><span class="o">/</span><span class="n">newd</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Mul</span> <span class="ow">and</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_Rational</span> <span class="ow">and</span> \
                        <span class="nb">len</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">rv</span><span class="o">.</span><span class="n">as_coeff_Mul</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="n">cos</span><span class="p">:</span> <span class="p">[],</span> <span class="n">sin</span><span class="p">:</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">(</span><span class="n">Mul</span><span class="o">.</span><span class="n">make_args</span><span class="p">(</span><span class="n">rv</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
                <span class="n">args</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">func</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">elif</span> <span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">is_Integer</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">exp</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span>
                    <span class="n">a</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">)):</span>
                <span class="c1"># XXX this is ok but pathological expression could be handled</span>
                <span class="c1"># more efficiently as in TRmorrie</span>
                <span class="n">args</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">func</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">([</span><span class="n">a</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span><span class="o">*</span><span class="n">a</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">cos</span><span class="p">]</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">sin</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">c</span> <span class="ow">and</span> <span class="n">s</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="n">n</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">sin</span><span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span><span class="p">)</span> <span class="o">+</span> <span class="n">sin</span><span class="p">(</span><span class="n">a1</span> <span class="o">-</span> <span class="n">a2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">cos</span><span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">a1</span> <span class="o">-</span> <span class="n">a2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">a1</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">a2</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">cos</span><span class="p">(</span><span class="n">a1</span> <span class="o">+</span> <span class="n">a2</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">a1</span> <span class="o">-</span> <span class="n">a2</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">TR8</span><span class="p">(</span><span class="n">expand_mul</span><span class="p">(</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR9</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sum of ``cos`` or ``sin`` terms as a product of ``cos`` or ``sin``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR9(cos(1) + cos(2))</span>
<span class="sd">    2*cos(1/2)*cos(3/2)</span>
<span class="sd">    &gt;&gt;&gt; TR9(cos(1) + 2*sin(1) + 2*sin(2))</span>
<span class="sd">    cos(1) + 4*sin(3/2)*cos(1/2)</span>

<span class="sd">    If no change is made by TR9, no re-arrangement of the</span>
<span class="sd">    expression will be made. For example, though factoring</span>
<span class="sd">    of common term is attempted, if the factored expression</span>
<span class="sd">    wasn&#39;t changed, the original expression will be returned:</span>

<span class="sd">    &gt;&gt;&gt; TR9(cos(3) + cos(3)*cos(2))</span>
<span class="sd">    cos(3) + cos(2)*cos(3)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="c1"># cos(a)+/-cos(b) can be combined into a product of cosines and</span>
            <span class="c1"># sin(a)+/-sin(b) can be combined into a product of cosine and</span>
            <span class="c1"># sine.</span>
            <span class="c1">#</span>
            <span class="c1"># If there are more than two args, the pairs which &quot;work&quot; will</span>
            <span class="c1"># have a gcd extractable and the remaining two terms will have</span>
            <span class="c1"># the above structure -- all pairs must be checked to find the</span>
            <span class="c1"># ones that work. args that don&#39;t have a common set of symbols</span>
            <span class="c1"># are skipped since this doesn&#39;t lead to a simpler formula and</span>
            <span class="c1"># also has the arbitrariness of combining, for example, the x</span>
            <span class="c1"># and y term instead of the y and z term in something like</span>
            <span class="c1"># cos(x) + cos(y) + cos(z).</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rv</span>

            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ordered</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
                    <span class="n">ai</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ai</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
                        <span class="n">aj</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">aj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">was</span> <span class="o">=</span> <span class="n">ai</span> <span class="o">+</span> <span class="n">aj</span>
                        <span class="n">new</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">was</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new</span> <span class="o">!=</span> <span class="n">was</span><span class="p">:</span>
                            <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update in place</span>
                            <span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">hit</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>  <span class="c1"># go to next i</span>
                <span class="k">if</span> <span class="n">hit</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">_f</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                        <span class="n">rv</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">rv</span>

            <span class="c1"># two-arg Add</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">trig_split</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">split</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rv</span>
            <span class="n">gcd</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">iscos</span> <span class="o">=</span> <span class="n">split</span>

            <span class="c1"># application of rule if possible</span>
            <span class="k">if</span> <span class="n">iscos</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">gcd</span><span class="o">*</span><span class="n">n1</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">gcd</span><span class="o">*</span><span class="n">sin</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">gcd</span><span class="o">*</span><span class="n">n1</span><span class="o">*</span><span class="mi">2</span><span class="o">*</span><span class="n">sin</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">n1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
                <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">gcd</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">((</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">process_common_addends</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">do</span><span class="p">)</span>  <span class="c1"># DON&#39;T sift by free symbols</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR10</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Separate sums in ``cos`` and ``sin``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR10(cos(a + b))</span>
<span class="sd">    -sin(a)*sin(b) + cos(a)*cos(b)</span>
<span class="sd">    &gt;&gt;&gt; TR10(sin(a + b))</span>
<span class="sd">    sin(a)*cos(b) + sin(b)*cos(a)</span>
<span class="sd">    &gt;&gt;&gt; TR10(sin(a + b + c))</span>
<span class="sd">    (-sin(a)*sin(b) + cos(a)*cos(b))*sin(c) +</span>
<span class="sd">    (sin(a)*cos(b) + sin(b)*cos(a))*cos(c)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">f</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span>
        <span class="n">arg</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ordered</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">Add</span><span class="o">.</span><span class="n">_from_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">sin</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">TR10</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">+</span> \
                        <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">TR10</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">TR10</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-</span> \
                        <span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">TR10</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">f</span> <span class="o">==</span> <span class="n">sin</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">b</span><span class="p">)</span> <span class="o">-</span> <span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR10i</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Sum of products to function of sum.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR10i(cos(1)*cos(3) + sin(1)*sin(3))</span>
<span class="sd">    cos(2)</span>
<span class="sd">    &gt;&gt;&gt; TR10i(cos(1)*sin(3) + sin(1)*cos(3) + cos(3))</span>
<span class="sd">    cos(3) + sin(4)</span>
<span class="sd">    &gt;&gt;&gt; TR10i(sqrt(2)*cos(x)*x + sqrt(6)*sin(x)*x)</span>
<span class="sd">    2*sqrt(2)*x*sin(x + pi/6)</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_ROOT2</span><span class="p">,</span> <span class="n">_ROOT3</span><span class="p">,</span> <span class="n">_invROOT3</span>
    <span class="k">if</span> <span class="n">_ROOT2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_roots</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">def</span> <span class="nf">do</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="c1"># args which can be expressed as A*(cos(a)*cos(b)+/-sin(a)*sin(b))</span>
            <span class="c1"># or B*(cos(a)*sin(b)+/-cos(b)*sin(a)) can be combined into</span>
            <span class="c1"># A*f(a+/-b) where f is either sin or cos.</span>
            <span class="c1">#</span>
            <span class="c1"># If there are more than two args, the pairs which &quot;work&quot; will have</span>
            <span class="c1"># a gcd extractable and the remaining two terms will have the above</span>
            <span class="c1"># structure -- all pairs must be checked to find the ones that</span>
            <span class="c1"># work.</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rv</span>

            <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ordered</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
                    <span class="n">ai</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">ai</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)):</span>
                        <span class="n">aj</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">aj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="k">continue</span>
                        <span class="n">was</span> <span class="o">=</span> <span class="n">ai</span> <span class="o">+</span> <span class="n">aj</span>
                        <span class="n">new</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">was</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">new</span> <span class="o">!=</span> <span class="n">was</span><span class="p">:</span>
                            <span class="n">args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">new</span>  <span class="c1"># update in place</span>
                            <span class="n">args</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="n">hit</span> <span class="o">=</span> <span class="kc">True</span>
                            <span class="k">break</span>  <span class="c1"># go to next i</span>
                <span class="k">if</span> <span class="n">hit</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">if</span> <span class="n">_f</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                        <span class="n">rv</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>

                <span class="k">return</span> <span class="n">rv</span>

            <span class="c1"># two-arg Add</span>
            <span class="n">split</span> <span class="o">=</span> <span class="n">trig_split</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="n">two</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">split</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">rv</span>
            <span class="n">gcd</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">same</span> <span class="o">=</span> <span class="n">split</span>

            <span class="c1"># identify and get c1 to be cos then apply rule if possible</span>
            <span class="k">if</span> <span class="n">same</span><span class="p">:</span>  <span class="c1"># coscos, sinsin</span>
                <span class="n">gcd</span> <span class="o">=</span> <span class="n">n1</span><span class="o">*</span><span class="n">gcd</span>
                <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">gcd</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">gcd</span><span class="o">*</span><span class="n">cos</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>  <span class="c1"># cossin, cossin</span>
                <span class="n">gcd</span> <span class="o">=</span> <span class="n">n1</span><span class="o">*</span><span class="n">gcd</span>
                <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="n">n2</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">gcd</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">gcd</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span>

        <span class="n">rv</span> <span class="o">=</span> <span class="n">process_common_addends</span><span class="p">(</span>
            <span class="n">rv</span><span class="p">,</span> <span class="n">do</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">ordered</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">free_symbols</span><span class="p">)))</span>

        <span class="c1"># need to check for inducible pairs in ratio of sqrt(3):1 that</span>
        <span class="c1"># appeared in different lists when sorting by coefficient</span>
        <span class="k">while</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
            <span class="n">byrad</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ai</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ai</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">ai</span><span class="o">.</span><span class="n">exp</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">Half</span> <span class="ow">and</span> \
                                <span class="n">ai</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_Integer</span><span class="p">:</span>
                            <span class="n">byrad</span><span class="p">[</span><span class="n">ai</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                            <span class="n">hit</span> <span class="o">=</span> <span class="mi">1</span>
                            <span class="k">break</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">hit</span><span class="p">:</span>
                    <span class="n">byrad</span><span class="p">[</span><span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>

            <span class="c1"># no need to check all pairs -- just check for the onees</span>
            <span class="c1"># that have the right ratio</span>
            <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">byrad</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="p">[</span><span class="n">_ROOT3</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">_invROOT3</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">byrad</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">byrad</span><span class="p">[</span><span class="n">a</span><span class="p">])):</span>
                            <span class="k">if</span> <span class="n">byrad</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                <span class="k">continue</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">byrad</span><span class="p">[</span><span class="n">b</span><span class="p">])):</span>
                                <span class="k">if</span> <span class="n">byrad</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                                    <span class="k">continue</span>
                                <span class="n">was</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="n">byrad</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">byrad</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">j</span><span class="p">])</span>
                                <span class="n">new</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">was</span><span class="p">)</span>
                                <span class="k">if</span> <span class="n">new</span> <span class="o">!=</span> <span class="n">was</span><span class="p">:</span>
                                    <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new</span><span class="p">)</span>
                                    <span class="n">byrad</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="n">byrad</span><span class="p">[</span><span class="n">b</span><span class="p">][</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
                                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">args</span> <span class="o">+</span> <span class="p">[</span><span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_f</span> <span class="k">for</span> <span class="n">_f</span> <span class="ow">in</span> <span class="n">v</span> <span class="k">if</span> <span class="n">_f</span><span class="p">])</span>
                                   <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">byrad</span><span class="o">.</span><span class="n">values</span><span class="p">()]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>  <span class="c1"># final pass to resolve any new inducible pairs</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR11</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function of double angle to product. The ``base`` argument can be used</span>
<span class="sd">    to indicate what is the un-doubled argument, e.g. if 3*pi/7 is the base</span>
<span class="sd">    then cosine and sine functions with argument 6*pi/7 will be replaced.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR11(sin(2*x))</span>
<span class="sd">    2*sin(x)*cos(x)</span>
<span class="sd">    &gt;&gt;&gt; TR11(cos(2*x))</span>
<span class="sd">    -sin(x)**2 + cos(x)**2</span>
<span class="sd">    &gt;&gt;&gt; TR11(sin(4*x))</span>
<span class="sd">    4*(-sin(x)**2 + cos(x)**2)*sin(x)*cos(x)</span>
<span class="sd">    &gt;&gt;&gt; TR11(sin(4*x/3))</span>
<span class="sd">    4*(-sin(x/3)**2 + cos(x/3)**2)*sin(x/3)*cos(x/3)</span>

<span class="sd">    If the arguments are simply integers, no change is made</span>
<span class="sd">    unless a base is provided:</span>

<span class="sd">    &gt;&gt;&gt; TR11(cos(2))</span>
<span class="sd">    cos(2)</span>
<span class="sd">    &gt;&gt;&gt; TR11(cos(4), 2)</span>
<span class="sd">    -sin(2)**2 + cos(2)**2</span>

<span class="sd">    There is a subtle issue here in that autosimplification will convert</span>
<span class="sd">    some higher angles to lower angles</span>

<span class="sd">    &gt;&gt;&gt; cos(6*pi/7) + cos(3*pi/7)</span>
<span class="sd">    -cos(pi/7) + cos(3*pi/7)</span>

<span class="sd">    The 6*pi/7 angle is now pi/7 but can be targeted with TR11 by supplying</span>
<span class="sd">    the 3*pi/7 base:</span>

<span class="sd">    &gt;&gt;&gt; TR11(_, 3*pi/7)</span>
<span class="sd">    -sin(3*pi/7)**2 + cos(3*pi/7)**2 + cos(3*pi/7)</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">if</span> <span class="n">base</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span>
            <span class="n">t</span> <span class="o">=</span> <span class="n">f</span><span class="p">(</span><span class="n">base</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">co</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
                <span class="n">co</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">as_coeff_Mul</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">rv</span>
            <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="n">t</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">base</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">f</span> <span class="ow">is</span> <span class="n">cos</span><span class="p">:</span>
                    <span class="k">return</span> <span class="p">(</span><span class="n">c</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="n">co</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span> <span class="mi">2</span><span class="o">*</span><span class="n">c</span><span class="o">*</span><span class="n">s</span><span class="o">/</span><span class="n">co</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">elif</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_Number</span><span class="p">:</span>
            <span class="c1"># make a change if the leading coefficient&#39;s numerator is</span>
            <span class="c1"># divisible by 2</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">m</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_coeff_Mul</span><span class="p">(</span><span class="n">rational</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">numerator</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">arg</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">numerator</span><span class="o">//</span><span class="mi">2</span><span class="o">*</span><span class="n">m</span><span class="o">/</span><span class="n">c</span><span class="o">.</span><span class="n">denominator</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">TR11</span><span class="p">(</span><span class="n">cos</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">TR11</span><span class="p">(</span><span class="n">sin</span><span class="p">(</span><span class="n">arg</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">sin</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">s</span><span class="o">*</span><span class="n">c</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="n">c</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">s</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR12</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Separate sums in ``tan``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR12(tan(x + y))</span>
<span class="sd">    (tan(x) + tan(y))/(-tan(x)*tan(y) + 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span> <span class="o">==</span> <span class="n">tan</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">arg</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">arg</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ordered</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">args</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">arg</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">Add</span><span class="o">.</span><span class="n">_from_args</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">TR12</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">),</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">tb</span> <span class="o">=</span> <span class="n">tan</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="o">+</span> <span class="n">tb</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">tan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">tb</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR12i</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Combine tan arguments as</span>
<span class="sd">    (tan(y) + tan(x))/(tan(x)*tan(y) - 1) -&gt; -tan(x + y)</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; ta, tb, tc = [tan(i) for i in (a, b, c)]</span>
<span class="sd">    &gt;&gt;&gt; TR12i((ta + tb)/(-ta*tb + 1))</span>
<span class="sd">    tan(a + b)</span>
<span class="sd">    &gt;&gt;&gt; TR12i((ta + tb)/(ta*tb - 1))</span>
<span class="sd">    -tan(a + b)</span>
<span class="sd">    &gt;&gt;&gt; TR12i((-ta - tb)/(ta*tb - 1))</span>
<span class="sd">    tan(a + b)</span>
<span class="sd">    &gt;&gt;&gt; eq = (ta + tb)/(-ta*tb + 1)**2*(-3*ta - 3*tc)/(2*(ta*tc - 1))</span>
<span class="sd">    &gt;&gt;&gt; TR12i(eq.expand())</span>
<span class="sd">    -3*tan(a + b)*tan(a + c)/(2*(tan(a) + tan(b) - 1))</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">..polys</span> <span class="k">import</span> <span class="n">factor</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">is_Add</span> <span class="ow">or</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Mul</span> <span class="ow">or</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Pow</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">as_numer_denom</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">d</span><span class="o">.</span><span class="n">args</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">n</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">dok</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">di</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">as_f_sign_1</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">m</span>
                <span class="k">if</span> <span class="n">s</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span> <span class="ow">and</span> <span class="n">f</span><span class="o">.</span><span class="n">is_Mul</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> \
                        <span class="nb">all</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">fi</span><span class="p">,</span> <span class="n">tan</span><span class="p">)</span> <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">args</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">f</span>

        <span class="n">d_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Mul</span><span class="o">.</span><span class="n">make_args</span><span class="p">(</span><span class="n">d</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">di</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">d_args</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">ok</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">g</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">m</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>
                <span class="n">dok</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
                <span class="n">d_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span>
                <span class="k">continue</span>
            <span class="k">if</span> <span class="n">di</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                <span class="n">di</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">di</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
                    <span class="n">d_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                    <span class="n">d_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
            <span class="k">elif</span> <span class="n">di</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">or</span> <span class="n">di</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_positive</span><span class="p">):</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">ok</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">g</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">m</span>
                    <span class="n">s</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">t</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>
                    <span class="n">dok</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">di</span><span class="o">.</span><span class="n">exp</span>
                    <span class="n">d_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="o">**</span><span class="n">di</span><span class="o">.</span><span class="n">exp</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">di</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">di</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">di</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
                        <span class="n">d_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">di</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                        <span class="n">d_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">dok</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">def</span> <span class="nf">ok</span><span class="p">(</span><span class="n">ni</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">ni</span><span class="o">.</span><span class="n">is_Add</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">ni</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">ni</span><span class="o">.</span><span class="n">args</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">tan</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">tan</span><span class="p">):</span>
                    <span class="k">return</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span>
        <span class="n">n_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">Mul</span><span class="o">.</span><span class="n">make_args</span><span class="p">(</span><span class="n">factor_terms</span><span class="p">(</span><span class="n">n</span><span class="p">)))</span>
        <span class="n">hit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ni</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">n_args</span><span class="p">):</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">ok</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span><span class="p">:</span>
                <span class="n">m</span> <span class="o">=</span> <span class="n">ok</span><span class="p">(</span><span class="o">-</span><span class="n">ni</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                    <span class="n">n_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ni</span><span class="o">.</span><span class="n">is_Add</span><span class="p">:</span>
                        <span class="n">ni</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">ni</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
                            <span class="n">n_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ni</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                            <span class="n">n_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="n">ni</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="n">ni</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">or</span> <span class="n">ni</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_positive</span><span class="p">):</span>
                        <span class="n">m</span> <span class="o">=</span> <span class="n">ok</span><span class="p">(</span><span class="n">ni</span><span class="o">.</span><span class="n">base</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">m</span><span class="p">:</span>
                            <span class="n">n_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ni</span> <span class="o">=</span> <span class="n">factor</span><span class="p">(</span><span class="n">ni</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">ni</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
                                <span class="n">n_args</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">ni</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
                                <span class="n">n_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
                            <span class="k">continue</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">n_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
            <span class="n">hit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">m</span><span class="p">])</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="n">dok</span><span class="p">[</span><span class="n">s</span><span class="p">]</span>
            <span class="n">newed</span> <span class="o">=</span> <span class="n">ed</span><span class="o">.</span><span class="n">extract_additively</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">newed</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">newed</span><span class="p">:</span>
                    <span class="n">dok</span><span class="p">[</span><span class="n">s</span><span class="p">]</span> <span class="o">=</span> <span class="n">newed</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">dok</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="n">n_args</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">*=</span> <span class="o">-</span><span class="n">tan</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">hit</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">n_args</span><span class="p">)</span><span class="o">/</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">d_args</span><span class="p">)</span><span class="o">/</span><span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">[(</span><span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span>
                <span class="n">tan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">i</span><span class="o">.</span><span class="n">args</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">e</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">dok</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>

        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR13</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Change products of ``tan`` or ``cot``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR13(tan(3)*tan(2))</span>
<span class="sd">    -tan(2)/tan(5) - tan(3)/tan(5) + 1</span>
<span class="sd">    &gt;&gt;&gt; TR13(cot(3)*cot(2))</span>
<span class="sd">    cot(2)*cot(5) + 1 + cot(3)*cot(5)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="c1"># XXX handle products of powers? or let power-reducing handle it?</span>
        <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="n">tan</span><span class="p">:</span> <span class="p">[],</span> <span class="n">cot</span><span class="p">:</span> <span class="p">[],</span> <span class="kc">None</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">ordered</span><span class="p">(</span><span class="n">Mul</span><span class="o">.</span><span class="n">make_args</span><span class="p">(</span><span class="n">rv</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="n">tan</span><span class="p">,</span> <span class="n">cot</span><span class="p">):</span>
                <span class="n">args</span><span class="p">[</span><span class="n">a</span><span class="o">.</span><span class="n">func</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">tan</span><span class="p">]</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">cot</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="kc">None</span><span class="p">]</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">/</span><span class="n">tan</span><span class="p">(</span><span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span><span class="p">)</span> <span class="o">+</span> <span class="n">tan</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">/</span><span class="n">tan</span><span class="p">(</span><span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">t</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tan</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
        <span class="k">while</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">t1</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">t2</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">cot</span><span class="p">(</span><span class="n">t1</span><span class="p">)</span><span class="o">*</span><span class="n">cot</span><span class="p">(</span><span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span><span class="p">)</span> <span class="o">+</span> <span class="n">cot</span><span class="p">(</span><span class="n">t2</span><span class="p">)</span><span class="o">*</span><span class="n">cot</span><span class="p">(</span><span class="n">t1</span> <span class="o">+</span> <span class="n">t2</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cot</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">()))</span>
        <span class="k">return</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TRmorrie</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Returns cos(x)*cos(2*x)*...*cos(2**(k-1)*x) -&gt; sin(2**k*x)/(2**k*sin(x))</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TRmorrie(cos(x)*cos(2*x))</span>
<span class="sd">    sin(4*x)/(4*sin(x))</span>
<span class="sd">    &gt;&gt;&gt; TRmorrie(7*Mul(*[cos(x) for x in range(10)]))</span>
<span class="sd">    7*sin(12)*sin(16)*cos(5)*cos(7)*cos(9)/(64*sin(1)*sin(3))</span>

<span class="sd">    Sometimes autosimplification will cause a power to be</span>
<span class="sd">    not recognized. e.g. in the following, cos(4*pi/7) automatically</span>
<span class="sd">    simplifies to -cos(3*pi/7) so only 2 of the 3 terms are</span>
<span class="sd">    recognized:</span>

<span class="sd">    &gt;&gt;&gt; TRmorrie(cos(pi/7)*cos(2*pi/7)*cos(4*pi/7))</span>
<span class="sd">    -sin(3*pi/7)*cos(3*pi/7)/(4*sin(pi/7))</span>

<span class="sd">    A touch by TR8 resolves the expression to a Rational</span>

<span class="sd">    &gt;&gt;&gt; TR8(_)</span>
<span class="sd">    -1/8</span>

<span class="sd">    In this case, if eq is unsimplified, the answer is obtained</span>
<span class="sd">    directly:</span>

<span class="sd">    &gt;&gt;&gt; eq = cos(pi/9)*cos(2*pi/9)*cos(3*pi/9)*cos(4*pi/9)</span>
<span class="sd">    &gt;&gt;&gt; TRmorrie(eq)</span>
<span class="sd">    1/16</span>

<span class="sd">    But if angles are made canonical with TR3 then the answer</span>
<span class="sd">    is not simplified without further work:</span>

<span class="sd">    &gt;&gt;&gt; TR3(eq)</span>
<span class="sd">    sin(pi/18)*cos(pi/9)*cos(2*pi/9)/2</span>
<span class="sd">    &gt;&gt;&gt; TRmorrie(_)</span>
<span class="sd">    sin(pi/18)*sin(4*pi/9)/(8*sin(pi/9))</span>
<span class="sd">    &gt;&gt;&gt; TR8(_)</span>
<span class="sd">    cos(7*pi/18)/(16*sin(pi/9))</span>
<span class="sd">    &gt;&gt;&gt; TR3(_)</span>
<span class="sd">    1/16</span>

<span class="sd">    The original expression would have resolve to 1/16 directly with TR8,</span>
<span class="sd">    however:</span>

<span class="sd">    &gt;&gt;&gt; TR8(eq)</span>
<span class="sd">    1/16</span>

<span class="sd">    References</span>
<span class="sd">    ==========</span>

<span class="sd">    https//en.wikipedia.org/wiki/Morrie%27s_law</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">args</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
        <span class="n">coss</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">other</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">as_base_exp</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Integer</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
                <span class="n">co</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">as_coeff_Mul</span><span class="p">()</span>
                <span class="n">args</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">co</span><span class="p">)</span>
                <span class="n">coss</span><span class="p">[</span><span class="n">b</span><span class="p">]</span> <span class="o">=</span> <span class="n">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

        <span class="n">new</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="n">c</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">no</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">while</span> <span class="n">c</span><span class="p">:</span>
                <span class="n">k</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">cc</span> <span class="o">=</span> <span class="n">ci</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">while</span> <span class="n">cc</span> <span class="ow">in</span> <span class="n">c</span><span class="p">:</span>
                    <span class="n">k</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">cc</span> <span class="o">*=</span> <span class="mi">2</span>
                <span class="k">if</span> <span class="n">k</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">newarg</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="n">k</span><span class="o">*</span><span class="n">ci</span><span class="o">*</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="o">**</span><span class="n">k</span><span class="o">/</span><span class="n">sin</span><span class="p">(</span><span class="n">ci</span><span class="o">*</span><span class="n">a</span><span class="p">)</span>
                    <span class="c1"># see how many times this can be taken</span>
                    <span class="n">take</span> <span class="o">=</span> <span class="kc">None</span>
                    <span class="n">ccs</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                        <span class="n">cc</span> <span class="o">/=</span> <span class="mi">2</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">ccs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                        <span class="n">take</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">coss</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">take</span> <span class="ow">or</span> <span class="n">coss</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                    <span class="c1"># update exponent counts</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">k</span><span class="p">):</span>
                        <span class="n">cc</span> <span class="o">=</span> <span class="n">ccs</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
                        <span class="n">key</span> <span class="o">=</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="o">*</span><span class="n">cc</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="n">coss</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="n">take</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">coss</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                            <span class="n">c</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">cc</span><span class="p">)</span>
                    <span class="n">new</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newarg</span><span class="o">**</span><span class="n">take</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">no</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">c</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">no</span>

        <span class="k">if</span> <span class="n">new</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">new</span> <span class="o">+</span> <span class="n">other</span> <span class="o">+</span> <span class="p">[</span>
                <span class="n">cos</span><span class="p">(</span><span class="n">k</span><span class="o">*</span><span class="n">a</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">args</span><span class="p">[</span><span class="n">a</span><span class="p">]]))</span>

        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR14</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert factored powers of sin and cos identities into simpler</span>
<span class="sd">    expressions.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR14((cos(x) - 1)*(cos(x) + 1))</span>
<span class="sd">    -sin(x)**2</span>
<span class="sd">    &gt;&gt;&gt; TR14((sin(x) - 1)*(sin(x) + 1))</span>
<span class="sd">    -cos(x)**2</span>
<span class="sd">    &gt;&gt;&gt; p1 = (cos(x) + 1)*(cos(x) - 1)</span>
<span class="sd">    &gt;&gt;&gt; p2 = (cos(y) - 1)*2*(cos(y) + 1)</span>
<span class="sd">    &gt;&gt;&gt; p3 = (3*(cos(y) - 1))*(3*(cos(y) + 1))</span>
<span class="sd">    &gt;&gt;&gt; TR14(p1*p2*p3*(x - 1))</span>
<span class="sd">    -18*(x - 1)*sin(x)**2*sin(y)**4</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">rv</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">if</span> <span class="n">first</span><span class="p">:</span>
            <span class="c1"># sort them by location in numerator and denominator</span>
            <span class="c1"># so the code below can just deal with positive exponents</span>
            <span class="n">n</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">as_numer_denom</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">d</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">:</span>
                <span class="n">newn</span> <span class="o">=</span> <span class="n">TR14</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">newd</span> <span class="o">=</span> <span class="n">TR14</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">first</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">newn</span> <span class="o">!=</span> <span class="n">n</span> <span class="ow">or</span> <span class="n">newd</span> <span class="o">!=</span> <span class="n">d</span><span class="p">:</span>
                    <span class="n">rv</span> <span class="o">=</span> <span class="n">newn</span><span class="o">/</span><span class="n">newd</span>
                <span class="k">return</span> <span class="n">rv</span>

        <span class="n">other</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">process</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_Pow</span><span class="p">:</span>
                <span class="n">b</span><span class="p">,</span> <span class="n">e</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_base_exp</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">or</span> <span class="n">b</span><span class="o">.</span><span class="n">is_positive</span><span class="p">):</span>
                    <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="k">continue</span>
                <span class="n">a</span> <span class="o">=</span> <span class="n">b</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
            <span class="n">m</span> <span class="o">=</span> <span class="n">as_f_sign_1</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">m</span> <span class="ow">or</span> <span class="n">m</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">func</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cos</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">e</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">:</span>
                    <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="o">**</span><span class="n">e</span><span class="p">)</span>
                <span class="k">continue</span>
            <span class="n">g</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">si</span> <span class="o">=</span> <span class="n">m</span>
            <span class="n">process</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">g</span><span class="p">,</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Number</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">a</span><span class="p">))</span>

        <span class="c1"># sort them to get like terms next to each other</span>
        <span class="n">process</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">ordered</span><span class="p">(</span><span class="n">process</span><span class="p">))</span>

        <span class="c1"># keep track of whether there was any change</span>
        <span class="n">nother</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>

        <span class="c1"># access keys</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">si</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">))</span>

        <span class="k">while</span> <span class="n">process</span><span class="p">:</span>
            <span class="n">A</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process</span><span class="p">:</span>
                <span class="n">B</span> <span class="o">=</span> <span class="n">process</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">is_Number</span> <span class="ow">and</span> <span class="n">B</span><span class="p">[</span><span class="n">e</span><span class="p">]</span><span class="o">.</span><span class="n">is_Number</span><span class="p">:</span>
                    <span class="c1"># both exponents are numbers</span>
                    <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">!=</span> <span class="n">B</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                            <span class="n">B</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">take</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">e</span><span class="p">],</span> <span class="n">B</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>

                            <span class="c1"># reinsert any remainder</span>
                            <span class="c1"># the B will likely sort after A so check it first</span>
                            <span class="k">if</span> <span class="n">B</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="n">take</span><span class="p">:</span>
                                <span class="n">rem</span> <span class="o">=</span> <span class="p">[</span><span class="n">B</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
                                <span class="n">rem</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">-=</span> <span class="n">take</span>
                                <span class="n">process</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rem</span><span class="p">)</span>
                            <span class="k">elif</span> <span class="n">A</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">!=</span> <span class="n">take</span><span class="p">:</span>
                                <span class="n">rem</span> <span class="o">=</span> <span class="p">[</span><span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">]</span>
                                <span class="n">rem</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">-=</span> <span class="n">take</span>
                                <span class="n">process</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rem</span><span class="p">)</span>

                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">cos</span><span class="p">):</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="n">sin</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="n">cos</span>
                            <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">*</span><span class="n">B</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">*</span><span class="n">t</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="n">take</span><span class="p">)</span>
                            <span class="k">continue</span>

                <span class="k">elif</span> <span class="n">A</span><span class="p">[</span><span class="n">e</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="p">[</span><span class="n">e</span><span class="p">]:</span>
                    <span class="c1"># both exponents are equal symbols</span>
                    <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">f</span><span class="p">]</span> <span class="o">==</span> <span class="n">B</span><span class="p">[</span><span class="n">f</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">A</span><span class="p">[</span><span class="n">si</span><span class="p">]</span> <span class="o">!=</span> <span class="n">B</span><span class="p">[</span><span class="n">si</span><span class="p">]:</span>
                            <span class="n">B</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="n">take</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="n">e</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">f</span><span class="p">],</span> <span class="n">cos</span><span class="p">):</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="n">sin</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">t</span> <span class="o">=</span> <span class="n">cos</span>
                            <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="o">-</span><span class="n">A</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">*</span><span class="n">B</span><span class="p">[</span><span class="n">g</span><span class="p">]</span><span class="o">*</span><span class="n">t</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">f</span><span class="p">]</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="n">take</span><span class="p">)</span>
                            <span class="k">continue</span>

            <span class="c1"># either we are done or neither condition above applied</span>
            <span class="n">other</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A</span><span class="p">[</span><span class="n">a</span><span class="p">]</span><span class="o">**</span><span class="n">A</span><span class="p">[</span><span class="n">e</span><span class="p">])</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">other</span><span class="p">)</span> <span class="o">!=</span> <span class="n">nother</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">Mul</span><span class="p">(</span><span class="o">*</span><span class="n">other</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR15</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert sin(x)*-2 to 1 + cot(x)**2.</span>

<span class="sd">    See _TR56 docstring for advanced use of ``max`` and ``pow``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR15(1 - 1/sin(x)**2)</span>
<span class="sd">    -cot(x)**2</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">Pow</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">sin</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">rv</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_TR56</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cot</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="nb">pow</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR16</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert cos(x)*-2 to 1 + tan(x)**2.</span>

<span class="sd">    See _TR56 docstring for advanced use of ``max`` and ``pow``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR16(1 - 1/cos(x)**2)</span>
<span class="sd">    -tan(x)**2</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">Pow</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">cos</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">ia</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">rv</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">_TR56</span><span class="p">(</span><span class="n">ia</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="nb">pow</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">a</span> <span class="o">!=</span> <span class="n">ia</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR111</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert f(x)**-i to g(x)**i where either ``i`` is an integer</span>
<span class="sd">    or the base is positive and f, g are: tan, cot; sin, csc; or cos, sec.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR111(1 - 1/tan(x)**2)</span>
<span class="sd">    -cot(x)**2 + 1</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">Pow</span><span class="p">)</span> <span class="ow">and</span>
                <span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">is_positive</span> <span class="ow">or</span> <span class="n">rv</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">is_integer</span> <span class="ow">and</span> <span class="n">rv</span><span class="o">.</span><span class="n">exp</span><span class="o">.</span><span class="n">is_negative</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">tan</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cot</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**-</span><span class="n">rv</span><span class="o">.</span><span class="n">exp</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">csc</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**-</span><span class="n">rv</span><span class="o">.</span><span class="n">exp</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sec</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">**-</span><span class="n">rv</span><span class="o">.</span><span class="n">exp</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TR22</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert tan(x)**2 to sec(x)**2 - 1 and cot(x)**2 to csc(x)**2 - 1.</span>

<span class="sd">    See _TR56 docstring for advanced use of ``max`` and ``pow``.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TR22(1 + tan(x)**2)</span>
<span class="sd">    sec(x)**2</span>
<span class="sd">    &gt;&gt;&gt; TR22(1 + cot(x)**2)</span>
<span class="sd">    csc(x)**2</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">Pow</span><span class="p">)</span> <span class="ow">and</span> <span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">func</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cot</span><span class="p">,</span> <span class="n">tan</span><span class="p">)):</span>
            <span class="k">return</span> <span class="n">rv</span>

        <span class="n">rv</span> <span class="o">=</span> <span class="n">_TR56</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">tan</span><span class="p">,</span> <span class="n">sec</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="nb">pow</span><span class="p">)</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">_TR56</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">cot</span><span class="p">,</span> <span class="n">csc</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="nb">max</span><span class="o">=</span><span class="nb">max</span><span class="p">,</span> <span class="nb">pow</span><span class="o">=</span><span class="nb">pow</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">TRpower</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert sin(x)**n and cos(x)**n with positive n to sums.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; TRpower(sin(x)**6)</span>
<span class="sd">    -15*cos(2*x)/32 + 3*cos(4*x)/16 - cos(6*x)/32 + 5/16</span>
<span class="sd">    &gt;&gt;&gt; TRpower(sin(x)**3*cos(2*x)**4)</span>
<span class="sd">    (3*sin(x)/4 - sin(3*x)/4)*(cos(4*x)/2 + cos(8*x)/8 + 3/8)</span>

<span class="sd">    References</span>
<span class="sd">    ==========</span>

<span class="sd">    * https://en.wikipedia.org/wiki/List_of_trigonometric_identities#Power-reduction_formulae</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">Pow</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">base</span><span class="p">,</span> <span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">))):</span>
            <span class="k">return</span> <span class="n">rv</span>
        <span class="n">b</span><span class="p">,</span> <span class="n">n</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">as_base_exp</span><span class="p">()</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_Integer</span> <span class="ow">and</span> <span class="n">n</span><span class="o">.</span><span class="n">is_positive</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_odd</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="n">n</span><span class="o">.</span><span class="n">is_odd</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">((</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span>
                      <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">k</span><span class="o">*</span><span class="n">sin</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">((</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">)]))</span>
            <span class="k">elif</span> <span class="n">n</span><span class="o">.</span><span class="n">is_even</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
                                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)])</span>
            <span class="k">elif</span> <span class="n">n</span><span class="o">.</span><span class="n">is_even</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
                <span class="n">rv</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span>
                      <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="n">k</span><span class="o">*</span><span class="n">cos</span><span class="p">((</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">k</span><span class="p">)</span><span class="o">*</span><span class="n">x</span><span class="p">)</span>
                            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)]))</span>
            <span class="k">if</span> <span class="n">n</span><span class="o">.</span><span class="n">is_even</span><span class="p">:</span>
                <span class="n">rv</span> <span class="o">+=</span> <span class="mi">2</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">n</span><span class="p">)</span><span class="o">*</span><span class="n">binomial</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">rv</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">L</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return count of trigonometric functions in expression.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; L(cos(x)+sin(x))</span>
<span class="sd">    2</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">Integer</span><span class="p">(</span><span class="n">rv</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">))</span>


<span class="c1"># ============== end of basic Fu-like tools =====================</span>

<span class="k">if</span> <span class="n">DIOFANT_DEBUG</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
    <span class="p">(</span><span class="n">TR0</span><span class="p">,</span> <span class="n">TR1</span><span class="p">,</span> <span class="n">TR2</span><span class="p">,</span> <span class="n">TR3</span><span class="p">,</span> <span class="n">TR4</span><span class="p">,</span> <span class="n">TR5</span><span class="p">,</span>
     <span class="n">TR6</span><span class="p">,</span> <span class="n">TR7</span><span class="p">,</span> <span class="n">TR8</span><span class="p">,</span> <span class="n">TR9</span><span class="p">,</span> <span class="n">TR10</span><span class="p">,</span> <span class="n">TR11</span><span class="p">,</span> <span class="n">TR12</span><span class="p">,</span> <span class="n">TR13</span><span class="p">,</span>
     <span class="n">TR2i</span><span class="p">,</span> <span class="n">TRmorrie</span><span class="p">,</span> <span class="n">TR14</span><span class="p">,</span> <span class="n">TR15</span><span class="p">,</span> <span class="n">TR16</span><span class="p">,</span>
     <span class="n">TR12i</span><span class="p">,</span> <span class="n">TR111</span><span class="p">,</span> <span class="n">TR22</span><span class="p">)</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="n">debug</span><span class="p">,</span> <span class="p">(</span><span class="n">TR0</span><span class="p">,</span> <span class="n">TR1</span><span class="p">,</span> <span class="n">TR2</span><span class="p">,</span> <span class="n">TR3</span><span class="p">,</span> <span class="n">TR4</span><span class="p">,</span> <span class="n">TR5</span><span class="p">,</span>
                                            <span class="n">TR6</span><span class="p">,</span> <span class="n">TR7</span><span class="p">,</span> <span class="n">TR8</span><span class="p">,</span> <span class="n">TR9</span><span class="p">,</span> <span class="n">TR10</span><span class="p">,</span> <span class="n">TR11</span><span class="p">,</span>
                                            <span class="n">TR12</span><span class="p">,</span> <span class="n">TR13</span><span class="p">,</span> <span class="n">TR2i</span><span class="p">,</span> <span class="n">TRmorrie</span><span class="p">,</span> <span class="n">TR14</span><span class="p">,</span>
                                            <span class="n">TR15</span><span class="p">,</span> <span class="n">TR16</span><span class="p">,</span> <span class="n">TR12i</span><span class="p">,</span> <span class="n">TR111</span><span class="p">,</span> <span class="n">TR22</span><span class="p">)))</span>


<span class="c1"># tuples are chains  --  (f, g) -&gt; lambda x: g(f(x))</span>
<span class="c1"># lists are choices  --  [f, g] -&gt; lambda x: min(f(x), g(x), key=objective)</span>

<span class="n">CTR1</span> <span class="o">=</span> <span class="p">[(</span><span class="n">TR5</span><span class="p">,</span> <span class="n">TR0</span><span class="p">),</span> <span class="p">(</span><span class="n">TR6</span><span class="p">,</span> <span class="n">TR0</span><span class="p">),</span> <span class="n">identity</span><span class="p">]</span>

<span class="n">CTR2</span> <span class="o">=</span> <span class="p">(</span><span class="n">TR11</span><span class="p">,</span> <span class="p">[(</span><span class="n">TR5</span><span class="p">,</span> <span class="n">TR0</span><span class="p">),</span> <span class="p">(</span><span class="n">TR6</span><span class="p">,</span> <span class="n">TR0</span><span class="p">),</span> <span class="n">TR0</span><span class="p">])</span>

<span class="n">CTR3</span> <span class="o">=</span> <span class="p">[(</span><span class="n">TRmorrie</span><span class="p">,</span> <span class="n">TR8</span><span class="p">,</span> <span class="n">TR0</span><span class="p">),</span> <span class="p">(</span><span class="n">TRmorrie</span><span class="p">,</span> <span class="n">TR8</span><span class="p">,</span> <span class="n">TR10i</span><span class="p">,</span> <span class="n">TR0</span><span class="p">),</span> <span class="n">identity</span><span class="p">]</span>

<span class="n">CTR4</span> <span class="o">=</span> <span class="p">[(</span><span class="n">TR4</span><span class="p">,</span> <span class="n">TR10i</span><span class="p">),</span> <span class="n">identity</span><span class="p">]</span>

<span class="n">RL1</span> <span class="o">=</span> <span class="p">(</span><span class="n">TR4</span><span class="p">,</span> <span class="n">TR3</span><span class="p">,</span> <span class="n">TR4</span><span class="p">,</span> <span class="n">TR12</span><span class="p">,</span> <span class="n">TR4</span><span class="p">,</span> <span class="n">TR13</span><span class="p">,</span> <span class="n">TR4</span><span class="p">,</span> <span class="n">TR0</span><span class="p">)</span>


<span class="c1"># XXX it&#39;s a little unclear how this one is to be implemented</span>
<span class="c1"># see Fu paper of reference, page 7. What is the Union symbol refering to?</span>
<span class="c1"># The diagram shows all these as one chain of transformations, but the</span>
<span class="c1"># text refers to them being applied independently. Also, a break</span>
<span class="c1"># if L starts to increase has not been implemented.</span>
<span class="n">RL2</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">(</span><span class="n">TR4</span><span class="p">,</span> <span class="n">TR3</span><span class="p">,</span> <span class="n">TR10</span><span class="p">,</span> <span class="n">TR4</span><span class="p">,</span> <span class="n">TR3</span><span class="p">,</span> <span class="n">TR11</span><span class="p">),</span>
    <span class="p">(</span><span class="n">TR5</span><span class="p">,</span> <span class="n">TR7</span><span class="p">,</span> <span class="n">TR11</span><span class="p">,</span> <span class="n">TR4</span><span class="p">),</span>
    <span class="p">(</span><span class="n">CTR3</span><span class="p">,</span> <span class="n">CTR1</span><span class="p">,</span> <span class="n">TR9</span><span class="p">,</span> <span class="n">CTR2</span><span class="p">,</span> <span class="n">TR4</span><span class="p">,</span> <span class="n">TR9</span><span class="p">,</span> <span class="n">TR9</span><span class="p">,</span> <span class="n">CTR4</span><span class="p">),</span>
    <span class="n">identity</span><span class="p">,</span>
<span class="p">]</span>


<div class="viewcode-block" id="fu"><a class="viewcode-back" href="../../../modules/simplify/simplify.html#diofant.simplify.fu.fu">[docs]</a><span class="k">def</span> <span class="nf">fu</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="n">x</span><span class="o">.</span><span class="n">count_ops</span><span class="p">())):</span>
    <span class="sd">&quot;&quot;&quot;Attempt to simplify expression by using transformation rules given</span>
<span class="sd">    in the algorithm by Fu et al.</span>

<span class="sd">    :func:`fu` will try to minimize the objective function ``measure``.</span>
<span class="sd">    By default this first minimizes the number of trig terms and then minimizes</span>
<span class="sd">    the number of total operations.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; fu(sin(50)**2 + cos(50)**2 + sin(pi/6))</span>
<span class="sd">    3/2</span>
<span class="sd">    &gt;&gt;&gt; fu(sqrt(6)*cos(x) + sqrt(2)*sin(x))</span>
<span class="sd">    2*sqrt(2)*sin(x + pi/3)</span>

<span class="sd">    CTR1 example</span>

<span class="sd">    &gt;&gt;&gt; eq = sin(x)**4 - cos(y)**2 + sin(y)**2 + 2*cos(x)**2</span>
<span class="sd">    &gt;&gt;&gt; fu(eq)</span>
<span class="sd">    cos(x)**4 - 2*cos(y)**2 + 2</span>

<span class="sd">    CTR2 example</span>

<span class="sd">    &gt;&gt;&gt; fu(S.Half - cos(2*x)/2)</span>
<span class="sd">    sin(x)**2</span>

<span class="sd">    CTR3 example</span>

<span class="sd">    &gt;&gt;&gt; fu(sin(a)*(cos(b) - sin(b)) + cos(a)*(sin(b) + cos(b)))</span>
<span class="sd">    sqrt(2)*sin(a + b + pi/4)</span>

<span class="sd">    CTR4 example</span>

<span class="sd">    &gt;&gt;&gt; fu(sqrt(3)*cos(x)/2 + sin(x)/2)</span>
<span class="sd">    sin(x + pi/3)</span>

<span class="sd">    Example 1</span>

<span class="sd">    &gt;&gt;&gt; fu(1-sin(2*x)**2/4-sin(y)**2-cos(x)**4)</span>
<span class="sd">    -cos(x)**2 + cos(y)**2</span>

<span class="sd">    Example 2</span>

<span class="sd">    &gt;&gt;&gt; fu(cos(4*pi/9))</span>
<span class="sd">    sin(pi/18)</span>
<span class="sd">    &gt;&gt;&gt; fu(cos(pi/9)*cos(2*pi/9)*cos(3*pi/9)*cos(4*pi/9))</span>
<span class="sd">    1/16</span>

<span class="sd">    Example 3</span>

<span class="sd">    &gt;&gt;&gt; fu(tan(7*pi/18)+tan(5*pi/18)-sqrt(3)*tan(5*pi/18)*tan(7*pi/18))</span>
<span class="sd">    -sqrt(3)</span>

<span class="sd">    Objective function example</span>

<span class="sd">    &gt;&gt;&gt; fu(sin(x)/cos(x))  # default objective function</span>
<span class="sd">    tan(x)</span>
<span class="sd">    &gt;&gt;&gt; fu(sin(x)/cos(x), measure=lambda x: -x.count_ops()) # maximize op count</span>
<span class="sd">    sin(x)/cos(x)</span>

<span class="sd">    References</span>
<span class="sd">    ==========</span>
<span class="sd">    http://rfdz.ph-noe.ac.at/fileadmin/Mathematik_Uploads/ACDCA/</span>
<span class="sd">    DESTIME2006/DES_contribs/Fu/simplification.pdf</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">fRL1</span> <span class="o">=</span> <span class="n">greedy</span><span class="p">(</span><span class="n">RL1</span><span class="p">,</span> <span class="n">measure</span><span class="p">)</span>
    <span class="n">fRL2</span> <span class="o">=</span> <span class="n">greedy</span><span class="p">(</span><span class="n">RL2</span><span class="p">,</span> <span class="n">measure</span><span class="p">)</span>

    <span class="n">was</span> <span class="o">=</span> <span class="n">rv</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">sympify</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">Expr</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="p">[</span><span class="n">fu</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">measure</span><span class="o">=</span><span class="n">measure</span><span class="p">)</span> <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">TR1</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">tan</span><span class="p">,</span> <span class="n">cot</span><span class="p">):</span>
        <span class="n">rv1</span> <span class="o">=</span> <span class="n">fRL1</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">measure</span><span class="p">(</span><span class="n">rv1</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">measure</span><span class="p">(</span><span class="n">rv</span><span class="p">)):</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">rv1</span>
        <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">tan</span><span class="p">,</span> <span class="n">cot</span><span class="p">):</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="n">TR2</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rv</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
        <span class="n">rv1</span> <span class="o">=</span> <span class="n">fRL2</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="n">rv2</span> <span class="o">=</span> <span class="n">TR8</span><span class="p">(</span><span class="n">TRmorrie</span><span class="p">(</span><span class="n">rv1</span><span class="p">))</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="nb">min</span><span class="p">([</span><span class="n">was</span><span class="p">,</span> <span class="n">rv</span><span class="p">,</span> <span class="n">rv1</span><span class="p">,</span> <span class="n">rv2</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="n">measure</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">min</span><span class="p">(</span><span class="n">TR2i</span><span class="p">(</span><span class="n">rv</span><span class="p">),</span> <span class="n">rv</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="n">measure</span><span class="p">)</span></div>


<span class="k">def</span> <span class="nf">process_common_addends</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">do</span><span class="p">,</span> <span class="n">key2</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">key1</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Apply ``do`` to addends of ``rv`` that (if key1=True) share at least</span>
<span class="sd">    a common absolute value of their coefficient and the value of ``key2`` when</span>
<span class="sd">    applied to the argument. If ``key1`` is False ``key2`` must be supplied and</span>
<span class="sd">    will be the only key applied.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># collect by absolute value of coefficient and key2</span>
    <span class="n">absc</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">key1</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">c</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_coeff_Mul</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">c</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">c</span> <span class="o">=</span> <span class="o">-</span><span class="n">c</span>
                <span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span>  <span class="c1"># put the sign on `a`</span>
            <span class="n">absc</span><span class="p">[(</span><span class="n">c</span><span class="p">,</span> <span class="n">key2</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> <span class="k">if</span> <span class="n">key2</span> <span class="k">else</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">key2</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="n">absc</span><span class="p">[(</span><span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">,</span> <span class="n">key2</span><span class="p">(</span><span class="n">a</span><span class="p">))]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;must have at least one key&#39;</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">hit</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">absc</span><span class="p">:</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">absc</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
        <span class="n">c</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">k</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">e</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="n">v</span><span class="p">,</span> <span class="n">evaluate</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">new</span> <span class="o">=</span> <span class="n">do</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">new</span> <span class="o">!=</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="n">new</span>
                <span class="n">hit</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">e</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">args</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">c</span><span class="o">*</span><span class="n">v</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">if</span> <span class="n">hit</span><span class="p">:</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="n">Add</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rv</span>


<span class="n">fufuncs</span> <span class="o">=</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">    TR0 TR1 TR2 TR3 TR4 TR5 TR6 TR7 TR8 TR9 TR10 TR10i TR11</span>
<span class="s1">    TR12 TR13 L TR2i TRmorrie TR12i</span>
<span class="s1">    TR14 TR15 TR16 TR111 TR22&#39;&#39;&#39;</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
<span class="n">FU</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">fufuncs</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">locals</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">,</span> <span class="n">fufuncs</span><span class="p">))))</span>


<span class="k">def</span> <span class="nf">_roots</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_ROOT2</span><span class="p">,</span> <span class="n">_ROOT3</span><span class="p">,</span> <span class="n">_invROOT3</span>
    <span class="n">_ROOT2</span><span class="p">,</span> <span class="n">_ROOT3</span> <span class="o">=</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
    <span class="n">_invROOT3</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">_ROOT3</span>


<span class="n">_ROOT2</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">trig_split</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">two</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the gcd, s1, s2, a1, a2, bool where</span>

<span class="sd">    If two is False (default) then::</span>
<span class="sd">        a + b = gcd*(s1*f(a1) + s2*f(a2)) where f = cos if bool else sin</span>
<span class="sd">    else:</span>
<span class="sd">        if bool, a + b was +/- cos(a1)*cos(a2) +/- sin(a1)*sin(a2) and equals</span>
<span class="sd">            n1*gcd*cos(a - b) if n1 == n2 else</span>
<span class="sd">            n1*gcd*cos(a + b)</span>
<span class="sd">        else a + b was +/- cos(a1)*sin(a2) +/- sin(a1)*cos(a2) and equals</span>
<span class="sd">            n1*gcd*sin(a + b) if n1 = n2 else</span>
<span class="sd">            n1*gcd*sin(b - a)</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; trig_split(cos(x), cos(y))</span>
<span class="sd">    (1, 1, 1, x, y, True)</span>
<span class="sd">    &gt;&gt;&gt; trig_split(2*cos(x), -2*cos(y))</span>
<span class="sd">    (2, 1, -1, x, y, True)</span>
<span class="sd">    &gt;&gt;&gt; trig_split(cos(x)*sin(y), cos(y)*sin(y))</span>
<span class="sd">    (sin(y), 1, 1, x, y, True)</span>

<span class="sd">    &gt;&gt;&gt; trig_split(cos(x), -sqrt(3)*sin(x), two=True)</span>
<span class="sd">    (2, 1, -1, x, pi/6, False)</span>
<span class="sd">    &gt;&gt;&gt; trig_split(cos(x), sin(x), two=True)</span>
<span class="sd">    (sqrt(2), 1, 1, x, pi/4, False)</span>
<span class="sd">    &gt;&gt;&gt; trig_split(cos(x), -sin(x), two=True)</span>
<span class="sd">    (sqrt(2), 1, -1, x, pi/4, False)</span>
<span class="sd">    &gt;&gt;&gt; trig_split(sqrt(2)*cos(x), -sqrt(6)*sin(x), two=True)</span>
<span class="sd">    (2*sqrt(2), 1, -1, x, pi/6, False)</span>
<span class="sd">    &gt;&gt;&gt; trig_split(-sqrt(6)*cos(x), -sqrt(2)*sin(x), two=True)</span>
<span class="sd">    (-2*sqrt(2), 1, 1, x, pi/3, False)</span>
<span class="sd">    &gt;&gt;&gt; trig_split(cos(x)/sqrt(6), sin(x)/sqrt(2), two=True)</span>
<span class="sd">    (sqrt(6)/3, 1, 1, x, pi/6, False)</span>
<span class="sd">    &gt;&gt;&gt; trig_split(-sqrt(6)*cos(x)*sin(y), -sqrt(2)*sin(x)*sin(y), two=True)</span>
<span class="sd">    (-2*sqrt(2)*sin(y), 1, 1, x, pi/3, False)</span>

<span class="sd">    &gt;&gt;&gt; trig_split(cos(x), sin(x))</span>
<span class="sd">    &gt;&gt;&gt; trig_split(cos(x), sin(z))</span>
<span class="sd">    &gt;&gt;&gt; trig_split(2*cos(x), -sin(x))</span>
<span class="sd">    &gt;&gt;&gt; trig_split(cos(x), -sqrt(3)*sin(x))</span>
<span class="sd">    &gt;&gt;&gt; trig_split(cos(x)*cos(y), sin(x)*sin(z))</span>
<span class="sd">    &gt;&gt;&gt; trig_split(cos(x)*cos(y), sin(x)*sin(y))</span>
<span class="sd">    &gt;&gt;&gt; trig_split(-sqrt(6)*cos(x), sqrt(2)*sin(x)*sin(y), two=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_ROOT2</span><span class="p">,</span> <span class="n">_ROOT3</span><span class="p">,</span> <span class="n">_invROOT3</span>
    <span class="k">if</span> <span class="n">_ROOT2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">_roots</span><span class="p">()</span>

    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">Factors</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">)]</span>
    <span class="n">ua</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">gcd</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">as_expr</span><span class="p">()</span>
    <span class="n">n1</span> <span class="o">=</span> <span class="n">n2</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span> <span class="ow">in</span> <span class="n">ua</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
        <span class="n">ua</span> <span class="o">=</span> <span class="n">ua</span><span class="o">.</span><span class="n">quo</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="o">-</span><span class="n">n1</span>
    <span class="k">elif</span> <span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span> <span class="ow">in</span> <span class="n">ub</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">quo</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span><span class="p">)</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="o">-</span><span class="n">n2</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">as_expr</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ua</span><span class="p">,</span> <span class="n">ub</span><span class="p">)]</span>

    <span class="k">def</span> <span class="nf">pow_cos_sin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">two</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return ``a`` as a tuple (r, c, s) such that</span>
<span class="sd">        ``a = (r or 1)*(c or 1)*(s or 1)``.</span>

<span class="sd">        Three arguments are returned (radical, c-factor, s-factor) as</span>
<span class="sd">        long as the conditions set by ``two`` are met; otherwise None is</span>
<span class="sd">        returned. If ``two`` is True there will be one or two non-None</span>
<span class="sd">        values in the tuple: c and s or c and r or s and r or s or c with c</span>
<span class="sd">        being a cosine function (if possible) else a sine, and s being a sine</span>
<span class="sd">        function (if possible) else oosine. If ``two`` is False then there</span>
<span class="sd">        will only be a c or s term in the tuple.</span>

<span class="sd">        ``two`` also require that either two cos and/or sin be present (with</span>
<span class="sd">        the condition that if the functions are the same the arguments are</span>
<span class="sd">        different or vice versa) or that a single cosine or a single sine</span>
<span class="sd">        be present with an optional radical.</span>

<span class="sd">        If the above conditions dictated by ``two`` are not met then None</span>
<span class="sd">        is returned.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">s</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">co</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
        <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
            <span class="n">co</span><span class="p">,</span> <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">as_coeff_Mul</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">two</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">a</span><span class="o">.</span><span class="n">is_Mul</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">a</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">[</span><span class="n">a</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
                <span class="n">c</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
                <span class="n">s</span> <span class="o">=</span> <span class="n">a</span>
            <span class="k">elif</span> <span class="n">a</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">a</span><span class="o">.</span><span class="n">exp</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">Half</span><span class="p">:</span>  <span class="c1"># autoeval doesn&#39;t allow -1/2</span>
                <span class="n">co</span> <span class="o">*=</span> <span class="n">a</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
                <span class="n">b</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">c</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">b</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">s</span><span class="p">:</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="n">b</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">s</span> <span class="o">=</span> <span class="n">b</span>
                <span class="k">elif</span> <span class="n">b</span><span class="o">.</span><span class="n">is_Pow</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">exp</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">Half</span><span class="p">:</span>
                    <span class="n">co</span> <span class="o">*=</span> <span class="n">b</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">return</span>
            <span class="k">return</span> <span class="n">co</span> <span class="k">if</span> <span class="n">co</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
            <span class="n">s</span> <span class="o">=</span> <span class="n">a</span>
        <span class="k">if</span> <span class="n">c</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">s</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">co</span> <span class="o">=</span> <span class="n">co</span> <span class="k">if</span> <span class="n">co</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="k">return</span> <span class="n">co</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">s</span>

    <span class="c1"># get the parts</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pow_cos_sin</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">coa</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">sa</span> <span class="o">=</span> <span class="n">m</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">pow_cos_sin</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">two</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">m</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="n">cob</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">m</span>

    <span class="c1"># check them</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">ca</span><span class="p">)</span> <span class="ow">and</span> <span class="n">cb</span> <span class="ow">or</span> <span class="n">ca</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
        <span class="n">coa</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="p">,</span> <span class="n">cob</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">sb</span> <span class="o">=</span> <span class="n">cob</span><span class="p">,</span> <span class="n">cb</span><span class="p">,</span> <span class="n">sb</span><span class="p">,</span> <span class="n">coa</span><span class="p">,</span> <span class="n">ca</span><span class="p">,</span> <span class="n">sa</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">two</span><span class="p">:</span>  <span class="c1"># need cos(x) and cos(y) or sin(x) and sin(y)</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ca</span> <span class="ow">or</span> <span class="n">sa</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">cb</span> <span class="ow">or</span> <span class="n">sb</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">s</span><span class="o">.</span><span class="n">func</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">return</span> <span class="n">gcd</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">s</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">cos</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">coa</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">cob</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">ca</span> <span class="ow">and</span> <span class="n">cb</span> <span class="ow">and</span> <span class="n">sa</span> <span class="ow">and</span> <span class="n">sb</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">func</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">sb</span><span class="o">.</span><span class="n">func</span><span class="p">)):</span>
                    <span class="k">return</span>
                <span class="n">args</span> <span class="o">=</span> <span class="p">{</span><span class="n">j</span><span class="o">.</span><span class="n">args</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="p">)}</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">args</span> <span class="ow">in</span> <span class="n">args</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">sb</span><span class="p">)):</span>
                    <span class="k">return</span>
                <span class="k">return</span> <span class="n">gcd</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">ca</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sa</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">ca</span><span class="p">,</span> <span class="n">sa</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">ca</span> <span class="ow">and</span> <span class="n">sa</span> <span class="ow">or</span> <span class="n">cb</span> <span class="ow">and</span> <span class="n">sb</span> <span class="ow">or</span> \
           <span class="n">two</span> <span class="ow">and</span> <span class="p">(</span><span class="n">ca</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sa</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">cb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">sb</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">ca</span> <span class="ow">or</span> <span class="n">sa</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">cb</span> <span class="ow">or</span> <span class="n">sb</span>
        <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">args</span> <span class="o">!=</span> <span class="n">s</span><span class="o">.</span><span class="n">args</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">coa</span><span class="p">:</span>
            <span class="n">coa</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cob</span><span class="p">:</span>
            <span class="n">cob</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
        <span class="k">if</span> <span class="n">coa</span> <span class="ow">is</span> <span class="n">cob</span><span class="p">:</span>
            <span class="n">gcd</span> <span class="o">*=</span> <span class="n">_ROOT2</span>
            <span class="k">return</span> <span class="n">gcd</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pi</span><span class="o">/</span><span class="mi">4</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">coa</span><span class="o">/</span><span class="n">cob</span> <span class="o">==</span> <span class="n">_ROOT3</span><span class="p">:</span>
            <span class="n">gcd</span> <span class="o">*=</span> <span class="mi">2</span><span class="o">*</span><span class="n">cob</span>
            <span class="k">return</span> <span class="n">gcd</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pi</span><span class="o">/</span><span class="mi">3</span><span class="p">,</span> <span class="kc">False</span>
        <span class="k">elif</span> <span class="n">coa</span><span class="o">/</span><span class="n">cob</span> <span class="o">==</span> <span class="n">_invROOT3</span><span class="p">:</span>
            <span class="n">gcd</span> <span class="o">*=</span> <span class="mi">2</span><span class="o">*</span><span class="n">coa</span>
            <span class="k">return</span> <span class="n">gcd</span><span class="p">,</span> <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span><span class="p">,</span> <span class="n">c</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">pi</span><span class="o">/</span><span class="mi">6</span><span class="p">,</span> <span class="kc">False</span>


<span class="k">def</span> <span class="nf">as_f_sign_1</span><span class="p">(</span><span class="n">e</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;If ``e`` is a sum that can be written as ``g*(a + s)`` where</span>
<span class="sd">    ``s`` is ``+/-1``, return ``g``, ``a``, and ``s`` where ``a`` does</span>
<span class="sd">    not have a leading negative coefficient.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; as_f_sign_1(x + 1)</span>
<span class="sd">    (1, x, 1)</span>
<span class="sd">    &gt;&gt;&gt; as_f_sign_1(x - 1)</span>
<span class="sd">    (1, x, -1)</span>
<span class="sd">    &gt;&gt;&gt; as_f_sign_1(-x + 1)</span>
<span class="sd">    (-1, x, -1)</span>
<span class="sd">    &gt;&gt;&gt; as_f_sign_1(-x - 1)</span>
<span class="sd">    (-1, x, 1)</span>
<span class="sd">    &gt;&gt;&gt; as_f_sign_1(2*x + 2)</span>
<span class="sd">    (2, x, 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">e</span><span class="o">.</span><span class="n">is_Add</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span>
    <span class="c1"># exact match</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">in</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span>
        <span class="k">if</span> <span class="n">b</span><span class="o">.</span><span class="n">is_Mul</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">is_Number</span> <span class="ow">and</span> <span class="n">b</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="o">-</span><span class="n">a</span><span class="p">,</span> <span class="o">-</span><span class="n">b</span>
            <span class="n">g</span> <span class="o">=</span> <span class="o">-</span><span class="n">g</span>
        <span class="k">return</span> <span class="n">g</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
    <span class="c1"># gcd match</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">Factors</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">e</span><span class="o">.</span><span class="n">args</span><span class="p">]</span>
    <span class="n">ua</span><span class="p">,</span> <span class="n">ub</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
    <span class="n">gcd</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">gcd</span><span class="p">(</span><span class="n">b</span><span class="p">)</span><span class="o">.</span><span class="n">as_expr</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span> <span class="ow">in</span> <span class="n">ua</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
        <span class="n">ua</span> <span class="o">=</span> <span class="n">ua</span><span class="o">.</span><span class="n">quo</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span> <span class="ow">in</span> <span class="n">ub</span><span class="o">.</span><span class="n">factors</span><span class="p">:</span>
        <span class="n">ub</span> <span class="o">=</span> <span class="n">ub</span><span class="o">.</span><span class="n">quo</span><span class="p">(</span><span class="n">S</span><span class="o">.</span><span class="n">NegativeOne</span><span class="p">)</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">n1</span> <span class="o">=</span> <span class="n">n2</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">.</span><span class="n">as_expr</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">(</span><span class="n">ua</span><span class="p">,</span> <span class="n">ub</span><span class="p">)]</span>
    <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">:</span>
        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">,</span> <span class="n">a</span>
        <span class="n">n1</span><span class="p">,</span> <span class="n">n2</span> <span class="o">=</span> <span class="n">n2</span><span class="p">,</span> <span class="n">n1</span>
    <span class="k">if</span> <span class="n">n1</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">gcd</span> <span class="o">=</span> <span class="o">-</span><span class="n">gcd</span>
        <span class="n">n2</span> <span class="o">=</span> <span class="o">-</span><span class="n">n2</span>

    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">gcd</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">n2</span>


<span class="k">def</span> <span class="nf">_osborne</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace all hyperbolic functions with trig functions using</span>
<span class="sd">    the Osborne rule.</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    ``d`` is a dummy variable to prevent automatic evaluation</span>
<span class="sd">    of trigonometric/hyperbolic functions.</span>


<span class="sd">    References</span>
<span class="sd">    ==========</span>

<span class="sd">    https//en.wikipedia.org/wiki/Hyperbolic_function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">HyperbolicFunction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="o">*</span><span class="n">d</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">a</span><span class="o">.</span><span class="n">is_Add</span> <span class="k">else</span> <span class="n">Add</span><span class="o">.</span><span class="n">_from_args</span><span class="p">([</span><span class="n">i</span><span class="o">*</span><span class="n">d</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="o">.</span><span class="n">args</span><span class="p">])</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">sinh</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">sin</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">cosh</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cos</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">tanh</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">I</span><span class="o">*</span><span class="n">tan</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">coth</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cot</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">I</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;unhandled </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_osbornei</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">d</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Replace all trig functions with hyperbolic functions using</span>
<span class="sd">    the Osborne rule.</span>

<span class="sd">    Notes</span>
<span class="sd">    =====</span>

<span class="sd">    ``d`` is a dummy variable to prevent automatic evaluation</span>
<span class="sd">    of trigonometric/hyperbolic functions.</span>

<span class="sd">    References</span>
<span class="sd">    ==========</span>

<span class="sd">    https//en.wikipedia.org/wiki/Hyperbolic_function</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">TrigonometricFunction</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">rv</span>
        <span class="n">a</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xreplace</span><span class="p">({</span><span class="n">d</span><span class="p">:</span> <span class="n">S</span><span class="o">.</span><span class="n">One</span><span class="p">})</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">sin</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">sinh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">I</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">cos</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">cosh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">tan</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">tanh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span><span class="n">I</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">cot</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">coth</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">*</span><span class="n">I</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">sec</span><span class="p">):</span>
            <span class="k">return</span> <span class="mi">1</span><span class="o">/</span><span class="n">cosh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rv</span><span class="p">,</span> <span class="n">csc</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">I</span><span class="o">/</span><span class="n">sinh</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;unhandled </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">rv</span><span class="o">.</span><span class="n">func</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bottom_up</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">hyper_as_trig</span><span class="p">(</span><span class="n">rv</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return an expression containing hyperbolic functions in terms</span>
<span class="sd">    of trigonometric functions. Any trigonometric functions initially</span>
<span class="sd">    present are replaced with Dummy symbols and the function to undo</span>
<span class="sd">    the masking and the conversion back to hyperbolics is also returned. It</span>
<span class="sd">    should always be true that::</span>

<span class="sd">        t, f = hyper_as_trig(expr)</span>
<span class="sd">        expr == f(t)</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; eq = sinh(x)**2 + cosh(x)**2</span>
<span class="sd">    &gt;&gt;&gt; t, f = hyper_as_trig(eq)</span>
<span class="sd">    &gt;&gt;&gt; f(fu(t))</span>
<span class="sd">    cosh(2*x)</span>

<span class="sd">    References</span>
<span class="sd">    ==========</span>

<span class="sd">    https//en.wikipedia.org/wiki/Hyperbolic_function</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.simplify</span> <span class="k">import</span> <span class="n">signsimp</span>
    <span class="kn">from</span> <span class="nn">.radsimp</span> <span class="k">import</span> <span class="n">collect</span>

    <span class="c1"># mask off trig functions</span>
    <span class="n">trigs</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">atoms</span><span class="p">(</span><span class="n">TrigonometricFunction</span><span class="p">)</span>
    <span class="n">reps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">t</span><span class="p">,</span> <span class="n">Dummy</span><span class="p">())</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">trigs</span><span class="p">]</span>
    <span class="n">masked</span> <span class="o">=</span> <span class="n">rv</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">reps</span><span class="p">))</span>

    <span class="c1"># get inversion substitutions in place</span>
    <span class="n">reps</span> <span class="o">=</span> <span class="p">[(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">reps</span><span class="p">]</span>

    <span class="n">d</span> <span class="o">=</span> <span class="n">Dummy</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">_osborne</span><span class="p">(</span><span class="n">masked</span><span class="p">,</span> <span class="n">d</span><span class="p">),</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">collect</span><span class="p">(</span><span class="n">signsimp</span><span class="p">(</span>
        <span class="n">_osbornei</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">xreplace</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">reps</span><span class="p">))),</span> <span class="n">I</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">sincos_to_sum</span><span class="p">(</span><span class="n">expr</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Convert products and powers of sin and cos to sums.</span>

<span class="sd">    Applied power reduction TRpower first, then expands products, and</span>
<span class="sd">    converts products to sums with TR8.</span>

<span class="sd">    Examples</span>
<span class="sd">    ========</span>

<span class="sd">    &gt;&gt;&gt; sincos_to_sum(16*sin(x)**3*cos(2*x)**2)</span>
<span class="sd">    7*sin(x) - 5*sin(3*x) + 3*sin(5*x) - sin(7*x)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">TR8</span><span class="p">(</span><span class="n">expand_mul</span><span class="p">(</span><span class="n">TRpower</span><span class="p">(</span><span class="n">expr</span><span class="p">)))</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2006-2018 SymPy Development Team, 2013-2019 Sergey B Kirpichev

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    

  

  <script type="text/javascript" src="../../../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>